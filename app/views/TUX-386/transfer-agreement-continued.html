{% extends "layouts/main-tux-386.html" %}

{% block pageTitle %}
  Transfer agreement
{% endblock %}

{% block content %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

  
      <h1 class="govuk-heading-l govuk-!-margin-bottom-3">Transfer agreement (part 2)</h1>

      <p class="govuk-hint govuk-!-margin-bottom-6">You must confirm all statements before proceeding. If you cannot, please close your browser and contact your transfer advisor.</p>

      <form class="form" action="upload" method="post">

        <div class="govuk-form-group ">
          <fieldset class="govuk-fieldset govuk-checkboxes">
            <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
              I confirm that the Departmental Records Officer (DRO) has signed off on the following:
            </legend>
            <div class="govuk-checkboxes__item">
              <input class="govuk-checkboxes__input" id="waste-4" name="dro" type="checkbox" value="barn">
              <label class="govuk-label govuk-checkboxes__label" for="waste-4">
                  The appraisal and selection decision
                </label>
            </div>
            <div class="govuk-checkboxes__item">
              <input class="govuk-checkboxes__input" id="waste-5" name="dro" type="checkbox" value="sarb">
              <label class="govuk-label govuk-checkboxes__label" for="waste-5">
                  The sensitivity review
                </label>
            </div>

          </fieldset>
        </div>

        <div class="govuk-button-group">
          <button class="govuk-button" data-module="govuk-button">Agree and continue</button>
          <a class="govuk-button govuk-button--secondary" href="home">Cancel</a>
        </div>

      </form>

    </div>
    <div class="govuk-grid-column-one-third">
      <details class="govuk-details" open data-module="govuk-details">
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">
            Consignment reference
          </span>
        </summary>
        <div class="govuk-details__text">
          MOCK-123-TDR
        </div>
      </details>
    </div>
  </div>

<script>// GDS Checkbox Validation Script - Both Required
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const checkboxes = document.querySelectorAll('input[name="dro"]');
  const checkboxContainer = document.querySelector('.govuk-checkboxes');
  
  // Define error messages for each checkbox - MUST match the value attributes
  const errorMessages = {
    'barn': 'Departmental Records Officer (DRO) must have signed off the appraisal and selection decision for records ',
    'sarb': 'Departmental Records Officer (DRO) must have signed off sensitivity review '
  };
  
  form.addEventListener('submit', function(e) {
    // Find all unchecked checkboxes
    const uncheckedBoxes = Array.from(checkboxes).filter(cb => !cb.checked);
    
    if (uncheckedBoxes.length > 0) {
      e.preventDefault();
      
      // Remove existing errors
      removeAllErrors();
      
      // Add error styling to form group
      const formGroup = checkboxContainer.closest('.govuk-form-group') || checkboxContainer.parentElement;
      formGroup.classList.add('govuk-form-group--error');
      
      // Add error to each unchecked checkbox
      uncheckedBoxes.forEach(checkbox => {
        addErrorToCheckbox(checkbox);
      });
      
      // Create error summary
      createErrorSummary(uncheckedBoxes);
      
      // Scroll to error summary
      document.getElementById('error-summary').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      // Both checkboxes are checked, remove any existing errors
      removeAllErrors();
    }
  });
  
  // Errors will only be removed on successful form submission
  
  function addErrorToCheckbox(checkbox) {
    const checkboxItem = checkbox.closest('.govuk-checkboxes__item');
    const label = checkboxItem.querySelector('.govuk-checkboxes__label');
    const errorId = `${checkbox.value}-error`;
    
    // Check if error already exists
    if (document.getElementById(errorId)) {
      return;
    }
    
    // Create error message
    const errorMessage = document.createElement('p');
    errorMessage.id = errorId;
    errorMessage.className = 'govuk-error-message';
    errorMessage.innerHTML = `<span class="govuk-visually-hidden">Error:</span> ${errorMessages[checkbox.value]}`;
    
    // Insert error after the label
    checkboxItem.parentElement.insertBefore(errorMessage, checkboxItem);
    
    // Update aria-describedby
    const existingDescribedBy = checkbox.getAttribute('aria-describedby') || '';
    const newDescribedBy = existingDescribedBy ? `${errorId} ${existingDescribedBy}` : errorId;
    checkbox.setAttribute('aria-describedby', newDescribedBy.trim());
  }
  
  function removeErrorFromCheckbox(checkbox) {
    const errorId = `${checkbox.value}-error`;
    const errorMsg = document.getElementById(errorId);
    
    if (errorMsg) {
      errorMsg.remove();
    }
    
    // Update aria-describedby
    const describedBy = checkbox.getAttribute('aria-describedby');
    if (describedBy) {
      const newDescribedBy = describedBy.replace(errorId, '').trim();
      if (newDescribedBy) {
        checkbox.setAttribute('aria-describedby', newDescribedBy);
      } else {
        checkbox.removeAttribute('aria-describedby');
      }
    }
  }
  
  function removeAllErrors() {
    // Remove all individual error messages
    checkboxes.forEach(cb => {
      removeErrorFromCheckbox(cb);
    });
    
    // Remove error styling
    const formGroup = checkboxContainer.closest('.govuk-form-group');
    if (formGroup) {
      formGroup.classList.remove('govuk-form-group--error');
    }
    
    // Remove error summary
    const errorSummary = document.getElementById('error-summary');
    if (errorSummary) {
      errorSummary.remove();
    }
  }
  
  function createErrorSummary(uncheckedBoxes) {
    // Remove existing error summary if present
    const existingSummary = document.getElementById('error-summary');
    if (existingSummary) {
      existingSummary.remove();
    }
    
    const errorSummary = document.createElement('div');
    errorSummary.id = 'error-summary';
    errorSummary.className = 'govuk-error-summary';
    errorSummary.setAttribute('aria-labelledby', 'error-summary-title');
    errorSummary.setAttribute('role', 'alert');
    errorSummary.setAttribute('tabindex', '-1');
    
    // Build list of errors
    const errorList = uncheckedBoxes.map(cb => {
      return `<li><a href="#${cb.id}">${errorMessages[cb.value]}</a></li>`;
    }).join('');
    
    errorSummary.innerHTML = `
      <h2 class="govuk-error-summary__title" id="error-summary-title">
        There is a problem
      </h2>
      <div class="govuk-error-summary__body">
        <ul class="govuk-list govuk-error-summary__list">
          ${errorList}
        </ul>
      </div>
    `;
    
    // Insert before the h1
    const h1 = document.querySelector('.govuk-heading-l');
    h1.parentElement.insertBefore(errorSummary, h1);
    
    // Add click handlers to error summary links
    const errorLinks = errorSummary.querySelectorAll('a');
    errorLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetCheckbox = document.getElementById(targetId);
        if (targetCheckbox) {
          targetCheckbox.closest('.govuk-checkboxes__item').scrollIntoView({ behavior: 'smooth', block: 'center' });
          targetCheckbox.focus();
        }
      });
    });
  }
});
</script>
{% endblock %}
